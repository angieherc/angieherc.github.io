name: Project Field Automation

on:
  issues:
    types: [opened, edited, labeled]

jobs:
  update-fields:
    runs-on: ubuntu-latest
    steps:
      - name: Update Project Fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |

            const TARGET_PROJECT_ID = "PVT_kwHOAQG1vc4BP7eW";
            const AREA_FIELD_ID = "PVTSSF_lAHOAQG1vc4BP7eWzg-MhYc";
            const AREA3_OPTION_ID = "08ac0c33";
            const SERVICE_FIELD_ID = "PVTSSF_lAHOAQG1vc4BP7eWzg-MitY";
            const OS_OPTION_ID = "af4dfc2b";

            if (!context.payload.issue) {
              console.log("No issue in payload. Skipping.");
              return;
            }

            const issueNodeId = context.payload.issue.node_id;
            const issueTitle = context.payload.issue.title || "";
            const issueBody = context.payload.issue.body || "";
            const text = (issueTitle + " " + issueBody).toLowerCase();

            // -------- RETRY LOOP FOR PROJECT ATTACHMENT --------
            let items = [];

            for (let attempt = 1; attempt <= 5; attempt++) {

              console.log(`Checking project linkage (attempt ${attempt})...`);

              const data = await github.graphql(`
                query {
                  node(id: "${issueNodeId}") {
                    ... on Issue {
                      projectItems(first: 20) {
                        nodes {
                          id
                          project { id }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                field {
                                  ... on ProjectV2SingleSelectField {
                                    id
                                  }
                                }
                                optionId
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `);

              if (
                data &&
                data.node &&
                data.node.projectItems &&
                data.node.projectItems.nodes
              ) {
                items = data.node.projectItems.nodes;
              }

              if (items.length > 0) break;

              await new Promise(resolve => setTimeout(resolve, 2000));
            }

            if (!items || items.length === 0) {
              console.log("Issue never attached to project. Exiting.");
              return;
            }

            // -------- PROCESS ITEMS --------
            for (const item of items) {

              if (!item.project || !item.project.id) {
                console.log("Skipping item without project reference");
                continue;
              }

              const existingValues = {};

              if (item.fieldValues && item.fieldValues.nodes) {
                for (const fv of item.fieldValues.nodes) {
                  if (
                    fv &&
                    fv.field &&
                    fv.field.id &&
                    fv.optionId
                  ) {
                    existingValues[fv.field.id] = fv.optionId;
                  }
                }
              }

              // ----- SET AREA -----
              if (item.project.id === TARGET_PROJECT_ID) {

                if (existingValues[AREA_FIELD_ID] !== AREA3_OPTION_ID) {

                  console.log("Setting Area to Area3...");

                  await github.graphql(`
                    mutation {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: "${item.project.id}"
                        itemId: "${item.id}"
                        fieldId: "${AREA_FIELD_ID}"
                        value: { singleSelectOptionId: "${AREA3_OPTION_ID}" }
                      }) {
                        projectV2Item { id }
                      }
                    }
                  `);

                } else {
                  console.log("Area already correct. Skipping.");
                }
              }

              // ----- SET SERVICE -----
              if (text.includes("openstack")) {

                if (existingValues[SERVICE_FIELD_ID] !== OS_OPTION_ID) {

                  console.log("Setting Service to os...");

                  await github.graphql(`
                    mutation {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: "${item.project.id}"
                        itemId: "${item.id}"
                        fieldId: "${SERVICE_FIELD_ID}"
                        value: { singleSelectOptionId: "${OS_OPTION_ID}" }
                      }) {
                        projectV2Item { id }
                      }
                    }
                  `);

                } else {
                  console.log("Service already correct. Skipping.");
                }
              }
            }
